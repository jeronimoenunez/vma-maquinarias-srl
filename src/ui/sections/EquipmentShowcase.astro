---
import type { ImageMetadata } from "astro";
import Container from "@/ui/components/Container.astro";
import EquipmentFilter from "@/islands/EquipmentFilter";
import { equipmentCatalog } from "@/data/equipment";

type Props = {
  title: string;
  subtitle?: string;
};

const { title, subtitle } = Astro.props as Props;

/* =========================
   Tipos base del catálogo
========================= */

type CatalogItem = {
  id?: string;
  name?: string;
  image?: string | ImageMetadata;

  type?: string;
  tipo?: string;
  category?: string;

  maxHeightM?: number;
  altura?: string | number;
  height?: string | number;

  power?: string;
  energia?: string;
  energiaTipo?: string;

  [key: string]: unknown;
};

type FilterItem = {
  id: string;
  type: string;
  maxHeightM: number;
  power: string;
  name: string;
  image?: string | ImageMetadata;

  // labels UI
  tipoLabel: string;
  alturaLabel: string;
  energiaLabel: string;
};

/* =========================
   Helpers seguros
========================= */

const rawCatalog = equipmentCatalog as unknown as CatalogItem[];

const pickType = (item: CatalogItem) =>
  item.type ?? item.tipo ?? item.category ?? "equipo";

const toNumber = (v: unknown) => {
  if (typeof v === "number") return v;
  if (typeof v === "string") {
    const m = v.replace(",", ".").match(/(\d+(\.\d+)?)/);
    return m ? Number(m[1]) : 0;
  }
  return 0;
};

const getImageSrc = (img?: string | ImageMetadata) => {
  if (!img) return "/images/placeholder.jpg"; // ← fallback real
  return typeof img === "string" ? img : img.src;
};

/* =========================
   Normalización al shape del filtro
========================= */

const toFilterItem = (item: CatalogItem, idx: number): FilterItem => {
  const type = pickType(item);

  const maxHeightM =
    typeof item.maxHeightM === "number"
      ? item.maxHeightM
      : toNumber(item.altura ?? item.height);

  const power = item.power ?? item.energia ?? item.energiaTipo ?? "—";

  const tipoLabel = item.tipo ?? item.type ?? item.category ?? "Equipo";

  const alturaLabel =
    typeof item.altura === "string"
      ? item.altura
      : typeof item.altura === "number"
        ? `${item.altura} m`
        : typeof item.maxHeightM === "number"
          ? `${item.maxHeightM} m`
          : typeof item.height === "string"
            ? item.height
            : typeof item.height === "number"
              ? `${item.height} m`
              : "—";

  const energiaLabel = power;

  return {
    id: item.id ?? `eq-${idx}`,
    type,
    maxHeightM,
    power,
    name: item.name ?? "Equipo sin nombre",
    image: item.image,

    tipoLabel,
    alturaLabel,
    energiaLabel,
  };
};

const catalog = rawCatalog.map(toFilterItem);
---

<section id="equipos" class="scroll-section">
  <Container>
    <div class="sticky-wrapper">
      
      <!-- LEFT -->
      <div class="left-panel">
        <div class="kicker">Catálogo</div>
        <h2 class="sectionTitle">{title}</h2>

        {subtitle && <p class="sectionSubtitle">{subtitle}</p>}

        <p class="sectionSubtitle" style="margin-top:12px;">
          Filtrá para encontrar el equipo adecuado según altura, tipo y disponibilidad.
        </p>

        <div class="filter-container">
          <EquipmentFilter client:load items={catalog as any} />
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right-panel">
        {catalog.map((item) => (
          <div class="equipment-slide">
            <div class="slide-card">
              <img
                src={getImageSrc(item.image)}
                alt={item.name}
                class="slide-image"
                loading="lazy"
              />

              <div class="info-overlay">
                <div class="badge">{item.tipoLabel}</div>
                <h3>{item.name}</h3>

                <div class="specs">
                  <span><strong>Altura:</strong> {item.alturaLabel}</span>
                  <span><strong>Energía:</strong> {item.energiaLabel}</span>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

    </div>
  </Container>
</section>

<style>
.scroll-section{
  background:#000;
  color:white;
}

.sticky-wrapper{
  display:grid;
  grid-template-columns:.8fr 1.2fr;
  gap:4rem;
}

.left-panel{
  position:sticky;
  top:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  z-index:10;
}

.filter-container{
  margin-top:2rem;
  background:rgba(255,255,255,.05);
  padding:20px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.1);
}

.right-panel{
  padding-bottom:20vh;
}

.equipment-slide{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.slide-card{
  width:100%;
  height:70vh;
  background:#111;
  border-radius:24px;
  overflow:hidden;
  position:relative;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.1);
}

.slide-image{
  width:100%;
  height:100%;
  object-fit:cover;
  opacity:.6;
  transition:transform .8s ease;
}

.equipment-slide:hover .slide-image{
  transform:scale(1.05);
}

.info-overlay{
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  padding:40px;
  background:linear-gradient(transparent,rgba(0,0,0,.9));
}

.badge{
  display:inline-block;
  padding:4px 12px;
  background:#3b82f6;
  border-radius:100px;
  font-size:12px;
  text-transform:uppercase;
  font-weight:bold;
  margin-bottom:12px;
}

h3{
  font-size:2rem;
  margin-bottom:8px;
}

.specs{
  display:flex;
  gap:20px;
  font-size:.9rem;
  color:#ccc;
}

@media (max-width:900px){
  .sticky-wrapper{grid-template-columns:1fr;}
  .left-panel{position:relative;height:auto;padding-top:4rem;}
  .equipment-slide{height:auto;margin-bottom:2rem;}
  .slide-card{height:400px;}
}
</style>
