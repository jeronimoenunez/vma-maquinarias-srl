---
import "@/ui/styles/global.css";
import Header from "@/ui/components/Header.astro";
import Footer from "@/ui/components/Footer.astro";

type Props = {
  title?: string;
  description?: string;
};

const {
  title = "VMA Máquinas",
  description = "Alquiler y venta de equipos de elevación. Respuesta rápida en obra.",
} = Astro.props as Props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>

  <body>
    <Header />
    <main>
      <slot />
    </main>
    <Footer />

    <script is:inline>
  function initScrollSpy() {
    const navLinks = Array.from(document.querySelectorAll('.nav a[href*="#"]'));

    const getHashId = (a) => {
      try {
        const url = new URL(a.href, window.location.href);
        return (url.hash || "").replace("#", "");
      } catch {
        const raw = a.getAttribute("href") || "";
        const idx = raw.indexOf("#");
        return idx >= 0 ? raw.slice(idx + 1) : "";
      }
    };

    const linkById = new Map(
      navLinks
        .map(a => [getHashId(a), a])
        .filter(([id]) => id)
    );

    const sections = Array.from(linkById.keys())
      .map(id => document.getElementById(id))
      .filter(Boolean);

    const setActive = (id) => {
      navLinks.forEach(a => {
        a.classList.remove("isActive");
        a.removeAttribute("aria-current");
      });

      const el = linkById.get(id);
      if (el) {
        el.classList.add("isActive");
        el.setAttribute("aria-current", "page");
      }
    };

    if (!sections.length) {
      console.warn("[scrollspy] No encontró secciones aún. Reintentando…");
      return false;
    }

    setActive((location.hash || "").replace("#", "") || sections[0].id);

    const observer = new IntersectionObserver((entries) => {
      const visible = entries
        .filter(e => e.isIntersecting)
        .sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];

      if (visible?.target?.id) setActive(visible.target.id);
    }, {
      rootMargin: "-35% 0px -55% 0px",
      threshold: [0.12, 0.25, 0.5]
    });

    sections.forEach(s => observer.observe(s));

    window.addEventListener("hashchange", () => {
      setActive((location.hash || "").replace("#", ""));
    });

    return true;
  }

  // 1) Cuando el DOM está listo
  window.addEventListener("DOMContentLoaded", () => {
    // 2) Intento inmediato
    if (initScrollSpy()) return;

    // 3) Reintentos cortos por si aún no están (seguro en Astro)
    let tries = 0;
    const t = setInterval(() => {
      tries++;
      if (initScrollSpy() || tries >= 10) clearInterval(t);
    }, 150);
  });
</script>

  </body>
</html>
